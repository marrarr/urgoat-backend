<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Czat</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
<h2>Czat z <span th:text="${znajomy}"></span></h2>
<div id="czat-box"></div>

<form id="form">
  <input type="text" id="wiadomosc" placeholder="Wpisz wiadomość" required/>
  <input type="file" id="zdjecie"/>
  <button type="submit">Wyślij</button>
</form>

<script th:inline="javascript">
  let czatId = [[${czatId}]];
  let nadawcaEmail = [[${nadawcaEmail}]];

  let socket = new SockJS('/ws');
  let stompClient = Stomp.over(socket);

  stompClient.connect({}, function () {
    stompClient.subscribe('/topic/czat/' + czatId, function (response) {
      let wiadomosc = JSON.parse(response.body);
      let div = document.createElement('div');
      div.innerHTML = "<b>" + wiadomosc.nadawcaEmail + ":</b> " + wiadomosc.tresc;
      document.getElementById("czat-box").appendChild(div);
    });
  });

  document.getElementById('form').addEventListener('submit', function (e) {
    e.preventDefault();
    let tresc = document.getElementById('wiadomosc').value;
    let plik = document.getElementById('zdjecie').files[0];

    if (plik) {
      let reader = new FileReader();
      reader.onload = function () {
        let base64 = reader.result.split(',')[1];
        wyslijWiadomosc(tresc, base64);
      };
      reader.readAsDataURL(plik);
    } else {
      wyslijWiadomosc(tresc, null);
    }

    document.getElementById('wiadomosc').value = '';
  });

  function wyslijWiadomosc(tresc, zdjecie) {
    stompClient.send("/app/chat.send/" + czatId, {}, JSON.stringify({
      tresc: tresc,
      nadawcaEmail: nadawcaEmail,
      czatId: czatId,
      zdjecie: zdjecie ? atob(zdjecie) : null
    }));
  }
</script>
</body>
</html>
